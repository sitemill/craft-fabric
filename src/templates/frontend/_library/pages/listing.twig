{% extends '_library/layouts/page.twig' %}

{% set show = 'all' %}
{% set pageTitle = 'All items' %}

{# Set up page settings #}
{% if elementType is defined %}
    {% if elementType == 'entries' %}
        {% set show = 'entries' %}
        {% set pageTitle = 'All entries' %}
        {% if elementSource is defined %}
            {% set entrySection = craft.entries.section(elementSource|camel) %}
            {% set pageTitle = craft.sections.sectionByHandle(elementSource|camel).name %}
        {% endif %}
    {% else %}
        {% set show = 'assets' %}
        {% set pageTitle = 'All Assets' %}
    {% endif %}
{% endif %}

{# Set up category if it exists #}
{% if categoryId is defined %}
    {% set category = craft.categories.id(categoryId).one() %}
    {% set pageTitle = category.title %}
    {# If category has parent, build breadcrumbs YUM #}
    {% if category.parent %}
        {% set breadcrumbs = [] %}
        {% for category in category.ancestors.all() %}
            {% set breadcrumbs = breadcrumbs|merge([{
                'title' : category.title,
                'url' : category.url
            }]) %}
        {% endfor %}
    {% endif %}
{% endif %}


{% block pageHeader %}
    {% set pageTitle = keywords ? "Searching for '" ~ keywords ~ "'" : pageTitle %}
    {{ parent() }}
{% endblock %}

{% block pageMain %}
    {% if show in ['all','assets'] %}
        {# Get assets source #}
        {% if craft.library.settings.assetsSource == 'dam' %}
            {% set assets = craft.damAssets %}
        {% else %}
            {% set assets = craft.assets.volume(craft.library.settings.assetsSource) %}
        {% endif %}

        {# Set query #}
        {% set assetQuery = assets
            .search(keywords)
            .kind(kind)
            .relatedTo(category)
            .orderBy(order)
            .with(['file[0]'])
            .limit(30) %}

        {% include '_library/components/listing.twig' with {
            type: 'assets',
            query: assetQuery
        } %}

    {% endif %}

    {% if show in ['all','entries'] %}

        {# If entry section not defined then get all enabled sections #}
        {% if entrySection is not defined %}
            {% set defaultEntriesSections = [] %}
            {% for source, value in craft.library.settings.entrySources if (value['enabled'] and value['showInSearch']) %}
                {% set defaultEntriesSections = defaultEntriesSections|merge([source]) %}
            {% endfor %}
            {% set entrySection = craft.entries.section(defaultEntriesSections) %}
        {% endif %}

        {% set entryQuery = entrySection
            .search(keywords)
            .relatedTo(category)
            .orderBy(order)
            .limit(30) %}

        {% include '_library/components/listing.twig' with {
            query: entryQuery,
            type: 'entries',
            showFilters: 0,
            showContext: 0
        } %}

    {% endif %}
{% endblock %}