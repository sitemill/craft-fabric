{# Check for user access #}
{% set publicLayout = false %}
{% if craft.library.settings.private and not currentUser %}
    {% if publicPage is defined and publicPage == true %}
        {% set publicLayout = true %}
    {% else %}
        {% requireLogin %}
    {% endif %}
{% endif %}

{% set userPermissions = {} %}
{# Let's set global user permissions once to help with performance #}
{% if currentUser %}
    {% set userPermissions = {
        'isAdmin' : currentUser.admin
    } %}
{% endif %}

{# Get colors #}
{% include '_library/settings/colors.twig' %}

{# Get any URL Parameters #}
{% set keywords = craft.app.request.getParam('q')|default(null) %}
{% set category = category is defined ? category : null %}
{% set kind = craft.app.request.getParam('kind')|default('*') %}
{% set order = craft.app.request.getParam('order')|default('title asc') %}
{% set layout = craft.app.request.getParam('layout')|default('grid') %}

{# Get and cache the entry sources #}
{% cache globally %}
    {% set entrySources = [] %}
    {% for source, settings in craft.library.settings.entrySources if (settings['enabled'] and settings['showInSearch']) %}
        {% set entrySources = entrySources|merge({
            (source) : {
                'title': craft.sections.sectionByHandle(source).name,
                'thumbnailField': settings.thumbnailField is defined ? settings.thumbnailField
            }
        }) %}
    {% endfor %}
{% endcache %}

{% block app %}
{% endblock %}